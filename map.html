
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TipTheVerse ‚Äî Drop a Pin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a1130" />
  <meta name="description" content="Drop a pin to show where the ripple touched down." />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <style>
    html, body { height: 100%; margin: 0; background:#0a1130; }
    body { font-family: system-ui, Arial, sans-serif; color:#fff; overflow: hidden; }
    #map { position: fixed; inset: 0; height: 100svh; width: 100vw; z-index: 0; }

    .topbar{ position: fixed; top: env(safe-area-inset-top, 10px); left:0; right:0; display:flex; justify-content:center; z-index:2; pointer-events:none; }
    .chip{ pointer-events:auto; background: rgba(10,17,48,.65); border:1px solid rgba(255,255,255,.35); color:#fff; padding:10px 14px; border-radius:999px; margin-top:8px; font-weight:800; letter-spacing:.2px; text-shadow:0 1px 4px rgba(0,0,0,.5); }

    .toolbar{ position: fixed; left:0; right:0; bottom: calc(10px + env(safe-area-inset-bottom, 0px));
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap; padding:0 14px; z-index:3; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; min-height:44px; padding:12px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.45); background:rgba(255,255,255,.15); color:#fff; text-decoration:none; font-weight:800; letter-spacing:.2px; backdrop-filter: blur(2px); touch-action: manipulation; }
    .btn:hover{ background: rgba(255,255,255,.25); }
    .btn.primary{ background: rgba(0,160,255,.25); border-color: rgba(120,200,255,.8); }
  </style>
</head>
<body>
  <div id="map" role="application" aria-label="Map to drop a pin"></div>

  <div class="topbar"><div class="chip">Drop a Pin where the ripple touched ‚ú®</div></div>

  <div class="toolbar" role="toolbar" aria-label="Map actions">
    <button id="locate" class="btn primary">üìç My Location</button>
    <button id="drop"   class="btn">üìå Drop Pin Here</button>
    <a href="index.html" class="btn">üè† Home</a>
  </div>

  <script type="module">
    // --- Firebase Config (yours) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCrgKxU2ng2yQQ-zsdcqYmx6No8eLT2Wiw",
      authDomain: "tiptheverse---ripples-map.firebaseapp.com",
      projectId: "tiptheverse---ripples-map",
      storageBucket: "tiptheverse---ripples-map.firebasestorage.app",
      messagingSenderId: "730375081757",
      appId: "1:730375081757:web:287cf70a4ae197a7589bf4",
      measurementId: "G-SZLNPRF9DJ"
    };

    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    await signInAnonymously(auth);

    // Leaflet base map
    const map = L.map('map', { zoomControl: true, tap: true });
    map.setView([33.7, -78.9], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // Layers
    const sharedLayer = L.layerGroup().addTo(map);
    const localLayer  = L.layerGroup().addTo(map);

    // Live pins from Firestore
    const pinsRef = collection(db, "pins");
    const q = query(pinsRef, orderBy("ts", "desc"), limit(500));
    onSnapshot(q, (snap) => {
      sharedLayer.clearLayers();
      snap.forEach(doc => {
        const p = doc.data();
        if (p && typeof p.lat === 'number' && typeof p.lng === 'number') {
          L.marker([p.lat, p.lng]).addTo(sharedLayer);
        }
      });
    });

    // Add pin helper with cooldown
    let lastDrop = 0;
    async function addSharedPin(latlng){
      const now = Date.now();
      if (now - lastDrop < 10000) return;
      lastDrop = now;
      try {
        await addDoc(pinsRef, { lat: latlng.lat, lng: latlng.lng, ts: serverTimestamp(), v: 1 });
        L.marker([latlng.lat, latlng.lng]).addTo(localLayer);
      } catch(e){ console.error("Pin add failed", e); }
    }

    // UI buttons
    document.getElementById('locate').addEventListener('click', () => {
      if (!navigator.geolocation) { alert('Location not available'); return; }
      navigator.geolocation.getCurrentPosition((pos) => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 14, {animate: true});
        addSharedPin({lat: latitude, lng: longitude});
      }, () => alert('Could not get location.'));
    });

    map.on('click', (e) => addSharedPin(e.latlng));
    document.getElementById('drop').addEventListener('click', () => addSharedPin(map.getCenter()));
  </script>
</body>
</html>

