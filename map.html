<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TipTheVerse — Ripples Map</title>
  <meta name="description" content="Drop a ripple, see where the clusters form. Anonymous, city-level pins only." />

  <!-- Leaflet core -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Heatmap plugin -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- Geocoder control -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- Marker clustering (optional but nice) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root {
      --bg: #0b0b0b;
      --fg: #f3f3f3;
      --muted: #b8c2cc;
      --accent: #3ec9ff;
      --card: #141414;
      --card2: #0f1115;
      --br: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { display: grid; grid-template-columns: 360px 1fr; grid-template-rows: auto 1fr; height: 100%; }
    header { grid-column: 1 / -1; padding: 18px 20px; display: flex; gap: 14px; align-items: center; justify-content: space-between; background: linear-gradient(180deg, #0b0b0bcc, #0b0b0b00 90%); position: sticky; top: 0; z-index: 10; }

    .brand { display: flex; align-items: center; gap: 12px; }
    .logo { width: 38px; height: 38px; border-radius: 50%; background: radial-gradient(circle at 35% 35%, #5be7ff, #0066ff 60%, #001c3b); box-shadow: 0 0 18px rgba(62,201,255,.45), inset 0 0 28px rgba(255,255,255,.08); }
    .title { font-weight: 700; letter-spacing: .3px; }
    .subtitle { color: var(--muted); font-size: 14px; }

    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .controls input, .controls select, .controls button { height: 42px; border-radius: 10px; border: 1px solid #232323; background: var(--card); color: var(--fg); padding: 0 12px; }
    .controls button { background: linear-gradient(180deg, #26b7ff, #0086ff); border: none; box-shadow: 0 10px 20px rgba(0, 134, 255, .25); cursor: pointer; font-weight: 600; }
    .controls button.secondary { background: #1b1d22; border: 1px solid #242830; box-shadow: none; color: #e6eef8; }

    aside { grid-row: 2; background: linear-gradient(180deg, var(--card2), #0c0f14); border-right: 1px solid #141821; padding: 14px; overflow: auto; }
    .panel { background: linear-gradient(180deg, #12161d, #0e1117); border: 1px solid #1a2030; border-radius: var(--br); padding: 14px; box-shadow: var(--shadow); }
    .panel h3 { margin: 6px 0 8px; font-size: 16px; color: #cfe7ff; }
    .panel p { margin: 0 0 10px; color: var(--muted); font-size: 14px; }

    .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
    .stat { background: #0f1218; border: 1px solid #182033; border-radius: 12px; padding: 10px; text-align: center; }
    .stat .n { font-size: 20px; font-weight: 700; }
    .stat .k { font-size: 12px; color: var(--muted); }

    .cluster-list { margin: 6px 0 0; display: grid; gap: 8px; }
    .cluster-item { background: #0f1218; border: 1px solid #182033; border-radius: 10px; padding: 10px; display: flex; align-items: center; justify-content: space-between; }
    .cluster-item .where { font-weight: 600; }
    .cluster-item .count { opacity: .9; }

    #map { grid-row: 2; height: min(75vh, calc(100vh - 120px)); width: 100%; }

    .cta { font-size: 14px; color: #b7d8ff; }

    /* small screens */
    @media (max-width: 900px) {
      .wrap { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; }
      aside { grid-row: 3; }
      #map { grid-row: 4; height: 60vh; }
    }
  .toolbar-spacer{width:8px;height:8px}
    .toggle { display:inline-flex; align-items:center; gap:6px; padding:0 10px; height:42px; border-radius:10px; border:1px solid #242830; background:#1b1d22; color:#e6eef8; cursor:pointer; }
    .toggle input{accent-color:#26b7ff}
    .pill { height:42px; border-radius:999px; background:#0e1117; border:1px solid #1a2030; padding:0 12px; display:inline-flex; align-items:center; gap:8px; }
    .pill select{ background:transparent; border:none; color:#e6eef8; height:32px; }
    .pill button{ background:#0f1218; border:1px solid #182033; border-radius:999px; height:32px; padding:0 10px; }

    /* Pulse marker */
    .ttv-pulse { position:relative; width:14px; height:14px; background:#26b7ff; border-radius:50%; box-shadow:0 0 0 2px rgba(38,183,255,.25); }
    .ttv-pulse::after{ content:''; position:absolute; inset:-6px; border-radius:50%; border:2px solid rgba(38,183,255,.45); animation:ttvRipple 1.6s ease-out 1 forwards; }
    @keyframes ttvRipple{ 0%{ transform:scale(.4); opacity:.9 } 100%{ transform:scale(2.2); opacity:0 } }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">TipTheVerse — Ripples Map</div>
          <div class="subtitle">Collective thought has power — see where the ripples are forming.</div>
        </div>
      </div>

      <div class="controls" role="group" aria-label="Drop a ripple controls">
        <label class="visually-hidden" for="stateSel">State</label>
        <select id="stateSel" title="Select state (optional)">
          <option value="">State (optional)</option>
          <option>AL</option><option>AK</option><option>AZ</option><option>AR</option>
          <option>CA</option><option>CO</option><option>CT</option><option>DE</option>
          <option>FL</option><option>GA</option><option>HI</option><option>ID</option>
          <option>IL</option><option>IN</option><option>IA</option><option>KS</option>
          <option>KY</option><option>LA</option><option>ME</option><option>MD</option>
          <option>MA</option><option>MI</option><option>MN</option><option>MS</option>
          <option>MO</option><option>MT</option><option>NE</option><option>NV</option>
          <option>NH</option><option>NJ</option><option>NM</option><option>NY</option>
          <option>NC</option><option>ND</option><option>OH</option><option>OK</option>
          <option>OR</option><option>PA</option><option>RI</option><option>SC</option>
          <option>SD</option><option>TN</option><option>TX</option><option>UT</option>
          <option>VT</option><option>VA</option><option>WA</option><option>WV</option>
          <option>WI</option><option>WY</option>
          <option>DC</option>
        </select>

        <input id="cityInput" list="cityHints" placeholder="City (e.g., Myrtle Beach)" />
        <datalist id="cityHints">
          <option value="Myrtle Beach"></option>
          <option value="Conway"></option>
          <option value="Little River"></option>
          <option value="North Myrtle Beach"></option>
          <option value="Longs"></option>
          <option value="Wilmington"></option>
          <option value="Virginia Beach"></option>
          <option value="Assateague"></option>
          <option value="Washington"></option>
          <option value="Philadelphia"></option>
          <option value="New York"></option>
          <option value="Los Angeles"></option>
          <option value="Chicago"></option>
          <option value="Austin"></option>
        </datalist>

        <input id="countryInput" placeholder="Country (optional, e.g., United States)" />

        <button id="dropBtn">Drop a Ripple</button>
        <button id="clickModeBtn" class="secondary" title="Place a pin by clicking the map">Click-to-Drop</button>
        <span class="toolbar-spacer"></span>

        <label class="toggle" title="Heatmap">
          <input type="checkbox" id="heatToggle" /> Heatmap
        </label>
        <div class="pill" title="Time window">
          <span>Time:</span>
          <select id="timeWindow">
            <option value="all">All time</option>
            <option value="30d">30 days</option>
            <option value="7d">7 days</option>
            <option value="24h">24 hours</option>
          </select>
        </div>
        <div class="pill" title="Export">
          <button id="exportCsvBtn">CSV</button>
          <button id="exportJsonBtn">JSON</button>
        </div>
        <button id="shareBtn" class="secondary" title="Copy a shareable link">Share view</button>
      </div>
    </header>

    <aside>
      <div class="panel">
        <h3>How it works</h3>
        <p><strong>This map is an experiment in collective thought.</strong> Every time someone feels a ripple return — a kindness, luck, or a good thing — they can place a pin. One ripple is powerful, but when thousands of people focus on the same intention, the effect multiplies. The clusters show us how quickly positivity can spread when shared energy is at play.</p>
        <p>All pins are anonymous, because it is not about credit — it's about the motion itself. You will feel the city-level pulse. By adding your ripple, you help us see and measure how collective thought can accelerate the good.</p>
        <p>Pick a city (and optional state/country) and tap <strong>Drop a Ripple</strong>. No names, no tracking — just a city-level pulse. Or use <em>Click-to-Drop</em> to place a pin anywhere on the map.</p>
        <p class="cta">Pins currently save on this device. We can switch to a tiny serverless backend so everyone sees the same pins, everywhere.</p>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>At a glance</h3>
        <div class="stats">
          <div class="stat"><div class="n" id="totalPins">0</div><div class="k">Total pins</div></div>
          <div class="stat"><div class="n" id="uniquePlaces">0</div><div class="k">Unique places</div></div>
        </div>
        <h3>Ripple clusters</h3>
        <div id="clusterList" class="cluster-list"></div>
      </div>
    </aside>

    <div id="map" role="application" aria-label="Ripples map"></div>
  </div>

  <script>
    // --- Minimal city → coordinate dictionary (expand anytime) ---
    const CITY_COORDS = new Map([
      ["Myrtle Beach, SC", [33.6891, -78.8867]],
      ["North Myrtle Beach, SC", [33.823, -78.6800]],
      ["Conway, SC", [33.8358, -79.0478]],
      ["Little River, SC", [33.8732, -78.6147]],
      ["Longs, SC", [33.9427, -78.7347]],
      ["Wilmington, NC", [34.2257, -77.9447]],
      ["Virginia Beach, VA", [36.8529, -75.9780]],
      ["Assateague, MD", [38.0930, -75.2065]],
      ["Washington, DC", [38.9072, -77.0369]],
      ["Philadelphia, PA", [39.9526, -75.1652]],
      ["New York, NY", [40.7128, -74.0060]],
      ["Los Angeles, CA", [34.0522, -118.2437]],
      ["Chicago, IL", [41.8781, -87.6298]],
      ["Austin, TX", [30.2672, -97.7431]],
    ]);

    // Utility: build a label from city + state + country (if provided)
    function placeLabel(city, state, country) {
      const parts = [];
      if (city && city.trim()) parts.push(city.trim());
      if (state && state.trim()) parts.push(state.trim());
      if (country && country.trim()) parts.push(country.trim());
      if (parts.length === 0) return "Unknown";
      return parts.join(', ');
    }

    // Map init
    const map = L.map('map', { worldCopyJump: true }).setView([37.8, -96], 4);

    // Basemap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Clustering group
    const clusterGroup = L.markerClusterGroup();
    map.addLayer(clusterGroup);

    // Heatmap layer (initially off)
    let heatLayer = L.heatLayer([], { radius: 22, blur: 18, maxZoom: 11 });

    function updateStateBadges(pins){
      stateBadgeLayer.clearLayers();
      const counts = {};
      pins.forEach(p=>{ const st = stateFromLabel(p.label); if(st) counts[st] = (counts[st]||0)+1; });
      Object.entries(counts).forEach(([st, n])=>{
        const c = STATE_CENTROIDS[st]; if(!c) return;
        const html = `<div style="
          background:#1a2333; border:1px solid #294066; color:#d9ecff;
          padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px;
          box-shadow:0 6px 16px rgba(0,0,0,.35); white-space:nowrap;">
          ${st}: ${n}
        </div>`;
        const icon = L.divIcon({ html, className:'ttv-state-badge', iconSize:null });
        L.marker([c[0], c[1]], { icon, interactive:false }).addTo(stateBadgeLayer);
      });
    }

    // Storage helpers
    const STORAGE_KEY = 'ttv_ripples_v1';
    function loadPins() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
    }
    function savePins(pins) { localStorage.setItem(STORAGE_KEY, JSON.stringify(pins)); }

    // Render pins from storage
    function renderPins() {
      clusterGroup.clearLayers();
      const pins = loadPins();
      pins.forEach(p => {
        const m = L.marker([p.lat, p.lng]);
        m.bindPopup(`<b>${p.label}</b><br/><small>${new Date(p.ts).toLocaleString()}</small>`);
        clusterGroup.addLayer(m);
      });
      updateStats(pins);
    }

    // Stats + clusters side panel
    function updateStats(pins) {
      const total = pins.length;
      document.getElementById('totalPins').textContent = total;

      const counts = new Map();
      pins.forEach(p => counts.set(p.label, (counts.get(p.label) || 0) + 1));
      document.getElementById('uniquePlaces').textContent = counts.size;

      // Sort by count desc
      const sorted = Array.from(counts.entries()).sort((a,b) => b[1]-a[1]).slice(0, 50);
      const list = document.getElementById('clusterList');
      list.innerHTML = '';
      if (sorted.length === 0) {
        const el = document.createElement('div');
        el.className = 'cluster-item';
        el.innerHTML = '<span class="where">No clusters yet</span><span class="count">—</span>';
        list.appendChild(el);
      } else {
        sorted.forEach(([label, count]) => {
          const el = document.createElement('div');
          el.className = 'cluster-item';
          el.innerHTML = `<span class="where">${label}</span><span class="count">×${count}</span>`;
          list.appendChild(el);
        });
      }
      // Update state badges overlay
      updateStateBadges(pins);

      // Update heatmap layer
      const asHeat = pins.map(p => [p.lat, p.lng, 1]);
      heatLayer.setLatLngs(asHeat);
      const heatOn = document.getElementById('heatToggle');
      if (heatOn && heatOn.checked) {
        if (!map.hasLayer(heatLayer)) heatLayer.addTo(map);
      } else if (map.hasLayer(heatLayer)) {
        map.removeLayer(heatLayer);
      }
    }

    // Drop logic
    function dropRipple(lat, lng, label, zoomTo = true) {
      const pins = loadPins();
      const p = { lat, lng, label, ts: Date.now() };
      pins.push(p);
      savePins(pins);
      const m = L.marker([lat, lng]).bindPopup(`<b>${label}</b><br/><small>${new Date(p.ts).toLocaleString()}</small>`);
      clusterGroup.addLayer(m);
      if (zoomTo) map.setView([lat, lng], Math.max(map.getZoom(), 6));
      updateStats(pins);
      m.openPopup();
    }

    // Controls
    const stateSel = document.getElementById('stateSel');
    const cityInput = document.getElementById('cityInput');
    const countryInput = document.getElementById('countryInput');

    // Nominatim geocoder (global)
    async function geocode(query) {
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('q', query);
      url.searchParams.set('format', 'json');
      url.searchParams.set('limit', '1');
      url.searchParams.set('addressdetails', '0');
      try {
        const res = await fetch(url.toString(), {
          headers: { 'Accept-Language': 'en', 'User-Agent': 'TipTheVerse-Ripples-Map/1.0 (public site)' }
        });
        if (!res.ok) throw new Error('Geocoder unavailable');
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          const item = data[0];
          return { lat: parseFloat(item.lat), lng: parseFloat(item.lon) };
        }
        return null;
      } catch (e) {
        console.warn(e);
        return null;
      }
    }

    document.getElementById('dropBtn').addEventListener('click', async () => {
      const city = cityInput.value.trim();
      const state = stateSel.value.trim();
      const country = countryInput.value.trim();
      const label = placeLabel(city, state, country);

      // Known dictionary? use it
      if (CITY_COORDS.has(label)) {
        const [lat, lng] = CITY_COORDS.get(label);
        dropRipple(lat, lng, label);
        return;
      }

      // Try matching by city only against dictionary keys (graceful fallback)
      for (const [key, coords] of CITY_COORDS.entries()) {
        if (city && key.toLowerCase().startsWith(city.toLowerCase()+",")) {
          dropRipple(coords[0], coords[1], key);
          return;
        }
      }

      // Global geocode
      if (city || state || country) {
        const q = label;
        const pos = await geocode(q);
        if (pos) { dropRipple(pos.lat, pos.lng, label); return; }
      }

      // If still unknown: enable click-to-drop mode with this label
      alert('Could not locate that place automatically — click on the map to place your ripple anywhere.');
      enableClickMode(label);
    });

    // Click-to-drop mode
    let clickModeLabel = null;
    function enableClickMode(label = null) {
      clickModeLabel = label || placeLabel(cityInput.value, stateSel.value, countryInput.value) || 'Somewhere';
      document.getElementById('clickModeBtn').classList.add('active');
    }
    function disableClickMode() {
      clickModeLabel = null;
      document.getElementById('clickModeBtn').classList.remove('active');
    }
    document.getElementById('clickModeBtn').addEventListener('click', () => {
      if (clickModeLabel) { disableClickMode(); } else { enableClickMode(); }
    });

    map.on('click', (e) => {
      if (!clickModeLabel) return;
      dropRipple(e.latlng.lat, e.latlng.lng, clickModeLabel);
      disableClickMode();
    });

    // Clear local pins
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (confirm('Remove all pins saved on this device?')) {
        localStorage.removeItem(STORAGE_KEY);
        renderPins();
      }
    });

    // First render
    renderPins();
    setTimeout(() => map.invalidateSize(), 250);

    // Add a geocoder search box that drops a ripple
    const geocoder = L.Control.geocoder({
      defaultMarkGeocode: false
    })
    .on('markgeocode', function(e) {
      const c = e.geocode.center;
      const name = e.geocode && e.geocode.name ? e.geocode.name : `${c.lat.toFixed(4)}, ${c.lng.toFixed(4)}`;
      dropRipple(c.lat, c.lng, name);
      map.setView(c, 7);
    })
    .addTo(map);

  </script>
</body>
</html>


