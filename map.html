<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TipTheVerse â€” Ripples Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Drop a ripple pin at the city level and watch where clusters form." />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Marker clustering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --card:#111821; --ink:#e9f1fb; --muted:#a9b8c9;
      --accent:#79d0ff; --accent-2:#7cffc4; --ring:rgba(121,208,255,0.35);
    }
    html, body { height: 100%; margin: 0; }
    body { background: var(--bg); color: var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; }

    /* Top nav (match your site) */
    .topnav{
      position: sticky; top:0; z-index: 40; display:flex; gap: 18px; align-items:center;
      padding: 12px 6vw; background: rgba(11,15,20,0.85); backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .topnav a{ color:var(--ink); font-weight:600; text-decoration:none; }
    .spacer{ flex:1; }

    /* Explainer card */
    .wrap { max-width: 1000px; margin: 18px auto; padding: 0 6vw; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px; padding: 18px; line-height: 1.6;
    }
    .card h2{ margin: 0 0 10px; font-size: clamp(22px, 2.2vw, 30px); }
    .card p{ margin: 8px 0; }
    .muted { color: var(--muted); font-size: 0.95rem; }

    /* Map must have a height or it won't appear */
    #map { height: calc(100vh - 220px); width: 100%; margin: 12px 0 24px; border-radius: 12px; overflow: hidden; }

    /* Clear button in map UI */
    .leaflet-control .ttv-btn{
      cursor:pointer; padding:8px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,.2); background:rgba(11,15,20,.85);
      color:#e9f1fb; font-weight:600; backdrop-filter:blur(6px);
    }
  </style>
</head>
<body>

  <!-- Site nav -->
  <nav class="topnav">
    <a href="index.html">TipTheVerse</a>
    <a href="map.html" aria-current="page">Map</a>
    <a href="manifestation.html">Manifestation</a>
    <a href="give.html">Give</a>
    <div class="spacer"></div>
  </nav>

  <div class="wrap">
    <!-- EXPLANATION BOX -->
    <section class="card" aria-labelledby="drop-ripple">
      <h2 id="drop-ripple">Drop Your Ripple âœ¨</h2>
      <p>
        Every time something good happensâ€”big or smallâ€”mark it here.
        <strong>Click on the map (or long-press on mobile) to drop a pin.</strong>
        Pins are anonymous and should be placed at the <strong>city level</strong>, not your exact address.
      </p>
      <p>
        <strong>Why drop a pin?</strong> When ripples gather in clusters, we can literally see collective
        intention turning into a wave. One ripple is beautiful. Ten thousand ripples in the same city?
        Thatâ€™s momentum ðŸŒŠ
      </p>
      <p class="muted">
        Be kind. Keep it anonymous. Share the good so others can feel it too.
      </p>
    </section>

    <!-- MAP -->
    <div id="map" role="region" aria-label="Ripples Map"></div>
  </div>

  <script>
    // --- Init map
    const map = L.map('map').setView([39.5, -98.35], 4); // USA-ish center

    // Tiles (no API key needed)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Cluster group
    const markers = L.markerClusterGroup();
    map.addLayer(markers);

    // --- Local storage for per-visitor persistence
    const LS_KEY = 'ttv_ripples_v1';

    function loadSavedPins() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function savePins(pins) {
      try { localStorage.setItem(LS_KEY, JSON.stringify(pins)); } catch {}
    }
    function renderSavedPins() {
      loadSavedPins().forEach(({lat, lng, note}) => {
        const m = L.marker([lat, lng]).bindPopup(note || 'Ripple âœ¨');
        markers.addLayer(m);
      });
    }
    renderSavedPins();

    // --- Drop a pin on click (desktop) and long-press (mobile)
    function addRipple(latlng) {
      const note = prompt('Optional: add a short note about your ripple (or leave blank):', '');
      const text = (note && note.trim()) ? note.trim() : 'Ripple âœ¨';
      const m = L.marker(latlng).bindPopup(text);
      markers.addLayer(m);

      const pins = loadSavedPins();
      pins.push({ lat: latlng.lat, lng: latlng.lng, note: text });
      savePins(pins);
    }

    map.on('click', (e) => addRipple(e.latlng));

    let pressTimer = null;
    let pressStartLatLng = null;
    function startPress(latlng) {
      pressStartLatLng = latlng;
      pressTimer = setTimeout(() => {
        addRipple(pressStartLatLng);
        pressTimer = null;
      }, 600);
    }
    function cancelPress() {
      if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; }
    }
    map.on('mousedown', (e) => startPress(e.latlng));
    map.on('mouseup', cancelPress);
    map.on('mousemove', cancelPress);
    map.on('touchstart', (e) => {
      if (e.latlng) startPress(e.latlng);
    });
    map.on('touchend', cancelPress);
    map.on('touchmove', cancelPress);

    // --- Clear my pins button
    const clearControl = L.control({position: 'topright'});
    clearControl.onAdd = function() {
      const div = L.DomUtil.create('div', 'leaflet-bar');
      div.innerHTML = `<button id="clearPinsBtn" class="ttv-btn">Clear my pins</button>`;
      return div;
    };
    clearControl.addTo(map);

    // Avoid map drag when clicking the button
    setTimeout(() => {
      const btn = document.getElementById('clearPinsBtn');
      if (!btn) return;
      L.DomEvent.disableClickPropagation(btn);
      btn.addEventListener('click', () => {
        localStorage.removeItem(LS_KEY);
        markers.clearLayers();
      });
    }, 0);
  </script>
</body>
</html>






